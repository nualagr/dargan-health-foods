{% extends "base.html" %}
{% load static %}
{% load products_tags %}

{% block title %}Product Details{% endblock %}

{% block page_header %}
<div class="container header-container">
    <div class="row">
        <div class="col"></div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Product Details Breadcrumbs Navigation -->
<div class="container-fluid breadcrumbs-container">
    <div class="row">
        <div class="col-12 col-lg-9 mx-auto col-xl-9 offset-xl-1">
            <div class="breadcrumbs">
                <ul class="items">
                    <li class="item home">
                        <a href="{% url 'home' %}" title="Go to Home Page">
                            Home
                        </a>
                    </li>
                    <li class="item products">
                        <a href="{% url 'products' %}" title="Go to Products Page">
                            Products
                        </a>
                    </li>
                    <li class="item category">
                        <a href="{% url 'products' %}?category={{ product.category }}"
                            title="Go to related Category Page">
                            {{ product.category|title|to_ampersand }}
                        </a>
                    </li>
                    <li class="item product">
                        <strong>{{ product.friendly_name }}</strong>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- Individual Product Details Container -->
<div class="container-fluid">
    <div class="individual-product-container">
        <!-- Individual Product Details Row -->
        <div class="row">
            <!-- Product Image Column -->
            <div class="col-12 col-md-6 col-lg-4 offset-lg-1 col-xl-4">
                <div class="product-image-container my-5">
                    {% if product.main_image %}
                    <img class="product-details-image" src="{{ MEDIA_URL }}{{ product.main_image }}"
                        alt="{{ product.abbreviated_friendly_name }}">
                    {% else %}
                    <img class="product-details-image" src="{{ MEDIA_URL }}/product_images/no-image-placeholder.svg"
                        alt="{{ product.abbreviated_friendly_name }}">
                    {% endif %}
                </div>
            </div>
            <!-- Product Details Column -->
            <div class="col-12 col-md-6 col-lg-5 col-xl-4 offset-xl-1">
                <div class="product-details-container mb-5 mt-md-5">
                    <h1>{{ product.friendly_name }}</h1>
                    <p>
                        <span class="stars-outer">
                            <span class="stars-inner" style="width:{% widthratio product.avg_rating 5 100 %}%;"></span>
                        </span>
                        <span class="text-muted">
                        {{ product.avg_rating|floatformat:1 }}&nbsp;&nbsp;
                        {% if reviews %}
                            <a href="{% url 'product_detail' product.id %}#collapseReviews" class="green-text-link" id="open-product-reviews">
                                ({{ reviews|length }} reviews)
                            </a>
                        {% endif %}
                        </span>
                    </p>
                    <p class="lead text-left font-weight-bold">â‚¬{{ product.price }}</p>
                    {% if tags %}
                    <p class="small">
                        <i class="fas fa-tag mr-1"></i>
                        {% for tag in tags %}
                        <a class="tag" href="{% url 'products' %}?tag={{ tag.tag.name }}">
                            {{ tag.tag.friendly_name }}&nbsp;
                        </a>
                        {% endfor %}
                    </p>
                    {% endif %}
                    {% if request.user.is_superuser %}
                    <small class="ml-3">
                        <a class="blue-text-link" href="{% url 'edit_product' product.id %}">Edit</a> |
                        <!-- Delete Modal Trigger -->
                        <a class="red-text-link" data-bs-toggle="modal" data-bs-target="#deleteModal">Delete</a>
                    </small>
                    {% endif %}
                    <p class="mt-3">
                        {{ product.information }}
                    </p>
                    <!-- Quantity Form and Add to Cart Button -->
                    <form class="row" action="{% url 'add_to_cart' product.id %}" method="POST">
                        {% csrf_token %}
                        <div class="col-2 m-0 pe-0">
                            <div class="input-group">
                                <input class="form-control qty-input rounded-0" type="number" name="quantity" value="1"
                                    min="1" max="99" data-item_id="{{ product.id }}" id="id_qty_{{ product.id }}">
                            </div>
                        </div>
                        <div class="col-10 m-0 ps-0">
                            <input type="submit" class="common-button btn-orange add-to-cart-btn" value="Add to Cart">
                        </div>
                        <!-- Submit the current url with the form so that we can redirect the user back to the same page once the item has been added to the Cart -->
                        <input type="hidden" name="redirect_url" value="{{ request.path }}">
                    </form>
                </div>
            </div>
        </div>
        <!-- Product Detail Accordion Row -->
        <div class="row">
            <div class="col-12 col-lg-9 mx-auto">
                <div class="accordion accordion-flush">
                    <!-- Product Details Accordion -->
                    <div class="accordion-item" id="accordionDetails">
                        <h4 class="accordion-product-info-header" id="headingDetails">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseDetails" aria-expanded="false" aria-controls="collapseDetails">
                                Details
                            </button>
                        </h4>
                    </div>
                    <div class="accordion-body collapse" id="collapseDetails" aria-labelledby="headingDetails">
                        <!-- Ingredients -->
                        {% if product.ingredients %}
                        <p>
                            <strong>
                                Ingredients:
                            </strong>
                        </p>
                        <p>
                        <ul>
                            {% for ingredient in product.ingredients|split:"," %}
                            <li>
                                {{ ingredient }}
                            </li>
                            {% endfor %}
                        </ul>
                        </p>
                        <br>
                        {% endif %}
                        <!-- Directions for Usage -->
                        {% if product.usage %}
                        <p>
                            <strong>
                                Usage:
                            </strong>
                        </p>
                        <p>
                            {{ product.usage }}
                        </p>
                        <br>
                        {% endif %}
                    </div>
                </div>
                <!-- More Information Accordion -->
                <div class="accordion-item" id="accordionMoreInformation">
                    <h4 class="accordion-product-info-header" id="headingMoreInformation">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseMoreInformation" aria-expanded="false"
                            aria-controls="collapseMoreInformation">
                            More Information
                        </button>
                    </h4>
                </div>
                <div class="accordion-body collapse" id="collapseMoreInformation"
                    aria-labelledby="headingMoreInformation">
                    {% if product.weight_g %}
                    <p>
                        <strong>
                            Weight:
                        </strong>
                        {{ product.weight_g }}g
                    </p>
                    <br>
                    {% endif %}
                    {% if product.free_from %}
                    <p>
                        <strong>
                            Free From:
                        </strong>
                        {{ product.free_from }}
                    </p>
                    <br>
                    {% endif %}
                    {% if product.allergens %}
                    <p>
                        <strong>
                            Allergens:
                        </strong>
                        {{ product.allergens }}
                    </p>
                    <br>
                    {% endif %}
                </div>
                <!-- Disclaimer Accordion -->
                <div class="accordion-item" id="accordionDisclaimer" role="tablist" aria-multiselectable="true">
                    <h4 class="accordion-product-info-header" id="headingDisclaimer">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseDisclaimer" role="tab" aria-expanded="false"
                            aria-controls="collapseDisclaimer">
                            Disclaimer
                        </button>
                    </h4>
                </div>
                <div class="accordion-body collapse" id="collapseDisclaimer" role="tabpanel"
                    aria-labelledby="headingDisclaimer">
                    <p>
                        Please note that while we take every care to make sure the product information displayed on our
                        website is correct, product recipes are regularly changed. This may affect nutrition and
                        allergen information therefore you should always check product labels and not rely solely on the
                        information presented here.
                    </p>
                </div>
                <!-- Customer Reviews Accordion -->
                <div class="accordion-item" id="accordionReviews">
                    <h4 class="accordion-product-info-header" id="headingReviews">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseReviews" aria-expanded="false" aria-controls="collapseReviews">
                            Customer Reviews
                        </button>
                    </h4>
                </div>
                <div class="accordion-body collapse" id="collapseReviews" aria-labelledby="headingReviews">
                {% if reviews %}
                    {% for review in reviews %}
                    <div>
                        <span class="stars-outer">
                            <span class="stars-inner" style="width:{% widthratio review.review_rating 5 100 %}%;"></span>
                        </span>
                        <span><strong>&nbsp;{{ review.review_title }}</strong></span>
                    </div>
                    <div class="my-1 text-muted">
                        <small>Reviewed by {{ review.user }} on {{ review.created }}
                        {% if request.user.is_authenticated %}
                            {% if user.id == review.user.id %}
                                <a href="{% url 'delete_review' review.id %}" class="red-text-link">Delete Review</a>
                            {% else %}
                            {% endif %}
                        {% endif %}
                        </small>
                    </div>
                    <div>
                        {{ review.review_content }}
                    </div>
                    <hr>
                    {% endfor %}
                {% else %}
                    <div>
                        <p>No customer reviews currently exist for this product.</p>
                    </div>
                {% endif %}
                </div>
                <!-- Product Review Form Accordion -->
                {% if request.user.is_authenticated %}
                <div class="accordion-item" id="accordionReviewForm" role="tablist" aria-multiselectable="true">
                    <h4 class="accordion-product-info-header" id="headingReviewForm">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseReviewForm" role="tab" aria-expanded="false"
                            aria-controls="collapseReviewForm">
                            Leave a Review
                        </button>
                    </h4>
                </div>
                <div class="accordion-body collapse" id="collapseReviewForm" role="tabpanel"
                    aria-labelledby="headingReviewForm">
                    <form class="form product-review-form" action="{% url 'product_detail' product.pk %}" method="POST">
                        {% csrf_token %}
                        {{ prform|crispy }}
                        <div class="button-row">
                            <button class="common-button btn-orange" action="submit" aria-label="Product Review Submit Button"><i class="fas fa-cloud-upload-alt"></i> Post Review</button>
                        </div>
                    </form>
                </div>
                {% else %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-0">
            <div class="modal-header">
                <h5 class="modal-title text-red" id="deleteModalLabel">{{ product.friendly_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                Are you sure that you want to delete this product?
            </div>
            <div class="modal-footer justify-content-center">
                <a class="common-button btn-forest-green" data-bs-dismiss="modal"><i
                        class="far fa-save"></i>&nbsp;Retain</a>
                <a class="common-button btn-grey" href="{% url 'delete_product' product.id %}" %}><i
                        class="far fa-trash-alt"></i>&nbsp;Delete</a>
            </div>
        </div>
    </div>
</div>
{% include 'includes/newsletter-subscription-box.html' %}
{% endblock %}

{% block postloadjs %}
{{ block.super }}
<script>
// Reveal Customer Reviews Accordion when Total Review Count clicked
$(document).ready(function() {
    $('#open-product-reviews').click(function() {
        let accordion_body = $("#collapseReviews")
        let accordion_button = $("#headingReviews").children("button")
        // Check that the accordion body has not already been opened
        if ( (accordion_body.hasClass("collapse")) && (accordion_body.is(":not(.show)")) ){
            // Toggle the 'collapse' class to reveal the Reviews Accordion Body Content
            accordion_body.toggleClass( "collapse" );
            // Toggle the 'collapsed' class so that the accordion button styling mimics that of a clicked accordion button
            accordion_button.toggleClass("collapsed");
            // Programmatically simulate clicking the button so that the accordion now closes when the user clicks on it to close it
            accordion_button.click();
        } 
    });
});
 </script>
{% endblock %}